version: '2'

services:

  zookeeper:
    image: debezium/zookeeper:1.1.1.Final
    ports:
      - 2181:2181
      - 2888:2888
      - 3888:3888
    environment:
      - LOG_LEVEL=WARN

  kafka:
    image: debezium/kafka:1.1.1.Final
    ports:
      - 9092:9092
    environment:
      - ZOOKEEPER_CONNECT=zookeeper:2181
      - CREATE_TOPICS=event:1:1:delete
      - KAFKA_LOG_RETENTION_MS=5000
      - KAFKA_LOG_RETENTION_CHECK_INTERVAL_MS=5000
      - LOG_LEVEL=WARN

  connect:
    image: debezium/connect:1.1.1.Final
    ports:
      - 8083:8083
    environment:
      - BOOTSTRAP_SERVERS=kafka:9092
      - GROUP_ID=1
      - CONFIG_STORAGE_TOPIC=my_connect_configs
      - OFFSET_STORAGE_TOPIC=my_connect_offsets
      - STATUS_STORAGE_TOPIC=my_connect_statuses
      - LOG_LEVEL=WARN

  mutable:
    image: dcdh1983/postgresql-10-debezium-centos7:latest
    ports:
      - 5432:5432
    environment:
      - POSTGRESQL_USER=postgresuser
      - POSTGRESQL_PASSWORD=postgrespassword
      - POSTGRESQL_DATABASE=mutable

  todo-query:
    image: postgres:11-alpine
    ports:
      - 5433:5432
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_DB=todo-query

  todo-email-notifier:
    image: postgres:11-alpine
    ports:
      - 5434:5432
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_DB=todo-email-notifier

  secret-store:
    image: debezium/postgres:11-alpine
    ports:
      - 5435:5432
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_DB=secret-store

  mailhog:
    image: mailhog/mailhog:v1.0.0
    ports:
      - 1025:1025
      - 8025:8025

  todo-write-app:
    image: damdamdeo/todo-write-app:latest
    ports:
      - 8084:8080
    environment:
      - JAVA_OPTIONS=-Dquarkus.http.host=0.0.0.0
        -Dmp.messaging.incoming.event-in.bootstrap.servers=kafka:9092
        -Dquarkus.datasource.jdbc.url=jdbc:postgresql://mutable:5432/mutable
        -Dquarkus.datasource.username=postgresuser
        -Dquarkus.datasource.password=postgrespassword
        -Dquarkus.datasource.secret-store.jdbc.url=jdbc:postgresql://secret-store:5432/secret-store
        -Dquarkus.datasource.secret-store.username=postgres
        -Dquarkus.datasource.secret-store.password=postgres
        -Dquarkus.datasource.mutable.jdbc.url=jdbc:postgresql://mutable:5432/mutable
        -Dquarkus.datasource.mutable.username=postgresuser
        -Dquarkus.datasource.mutable.password=postgrespassword
        -Dquarkus.datasource.consumed-events.jdbc.url=jdbc:postgresql://mutable:5432/mutable
        -Dquarkus.datasource.consumed-events.username=postgresuser
        -Dquarkus.datasource.consumed-events.password=postgrespassword
        -Dkafka-connector-api/mp-rest/url=http://connect:8083
        -Dconnector.mutable.database.hostname=mutable
        -Dconnector.mutable.database.username=postgresuser
        -Dconnector.mutable.database.password=postgrespassword
        -Dconnector.mutable.database.port=5432
        -Dconnector.mutable.database.dbname=mutable
        -Dquarkus.oidc.auth-server-url=http://keycloak:8080/auth/realms/todos
        -Dquarkus.jaeger.endpoint=http://jaeger:14268/api/traces
        -Dquarkus.jaeger.tags=env=local

  todo-query-app:
    image: damdamdeo/todo-query-app:latest
    ports:
      - 8085:8080
    environment:
      - JAVA_OPTIONS=-Dquarkus.http.host=0.0.0.0
        -Dmp.messaging.incoming.event-in.bootstrap.servers=kafka:9092
        -Dquarkus.datasource.jdbc.url=jdbc:postgresql://todo-query:5432/todo-query
        -Dquarkus.datasource.username=postgres
        -Dquarkus.datasource.password=postgres
        -Dquarkus.datasource.secret-store.jdbc.url=jdbc:postgresql://secret-store:5432/secret-store
        -Dquarkus.datasource.secret-store.username=postgres
        -Dquarkus.datasource.secret-store.password=postgres
        -Dquarkus.datasource.consumed-events.jdbc.url=jdbc:postgresql://todo-query:5432/todo-query
        -Dquarkus.datasource.consumed-events.username=postgres
        -Dquarkus.datasource.consumed-events.password=postgres
        -Dquarkus.oidc.auth-server-url=http://keycloak:8080/auth/realms/todos
        -Dquarkus.jaeger.endpoint=http://jaeger:14268/api/traces
        -Dquarkus.jaeger.tags=env=local

  todo-email-notifier-app:
    image: damdamdeo/todo-email-notifier-app:latest
    environment:
      - JAVA_OPTIONS=-Dmp.messaging.incoming.event-in.bootstrap.servers=kafka:9092
        -Dquarkus.datasource.secret-store.jdbc.url=jdbc:postgresql://secret-store:5432/secret-store
        -Dquarkus.datasource.secret-store.username=postgres
        -Dquarkus.datasource.secret-store.password=postgres
        -Dquarkus.datasource.consumed-events.jdbc.url=jdbc:postgresql://todo-email-notifier:5432/todo-email-notifier
        -Dquarkus.datasource.consumed-events.username=postgres
        -Dquarkus.datasource.consumed-events.password=postgres
        -Dquarkus.mailer.host=mailhog
        -Dquarkus.mailer.username=
        -Dquarkus.mailer.password=

  todo-public-frontend-app:
    image: damdamdeo/todo-public-frontend-app:latest
    ports:
      - 8086:8080
    environment:
      - JAVA_OPTIONS=-Dtodo-write-api/mp-rest/url=http://todo-write-app:8080
        -Dtodo-query-api/mp-rest/url=http://todo-query-app:8080
        -Dquarkus.oidc.auth-server-url=http://keycloak:8080/auth/realms/todos
        -Dkeycloak-api/mp-rest/url=http://keycloak:8080/auth/realms/todos
        -Dkeycloak.admin.clientId=admin-cli
        -Dkeycloak.admin.username=keycloak
        -Dkeycloak.admin.password=keycloak
        -Dquarkus.http.cors=false
        -Dquarkus.jaeger.endpoint=http://jaeger:14268/api/traces
        -Dquarkus.jaeger.tags=env=local

  keycloak-db:
    image: debezium/postgres:11-alpine
    ports:
      - 5436:5432
    environment:
      - POSTGRES_USER=keycloak
      - POSTGRES_PASSWORD=keycloak
      - POSTGRES_DB=keycloak

  keycloak:
    image: damdamdeo/todo-keycloak:latest
    ports:
      - 8087:8080
    environment:
      - KEYCLOAK_USER=keycloak
      - KEYCLOAK_PASSWORD=keycloak
      - DB_VENDOR=postgres
      - DB_ADDR=keycloak-db:5432
      - DB_DATABASE=keycloak
      - DB_USER=keycloak
      - DB_PASSWORD=keycloak

  jaeger:
    image: jaegertracing/all-in-one:latest
    ports:
      - 5775:5775/udp
      - 6831:6831/udp
      - 6832:6832/udp
      - 5778:5778
      - 16686:16686
      - 14268:14268
