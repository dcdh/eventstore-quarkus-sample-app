version: '2'

services:

  zookeeper:
    image: debezium/zookeeper:1.1.1.Final
    ports:
      - 2181:2181
      - 2888:2888
      - 3888:3888
    environment:
      - LOG_LEVEL=WARN

  kafka:
    image: debezium/kafka:1.1.1.Final
    ports:
      - 9092:9092
    links:
      - zookeeper
    environment:
      - ZOOKEEPER_CONNECT=zookeeper:2181
      - CREATE_TOPICS=event:1:1:delete,aggregateroot:1:1:delete,flyway_schema_history:1:1:delete,test:1:1:delete
      - KAFKA_LOG_RETENTION_MS=5000
      - KAFKA_LOG_RETENTION_CHECK_INTERVAL_MS=5000
      - LOG_LEVEL=WARN

  kafka-rest:
    image: confluentinc/cp-kafka-rest:5.2.2-1
    ports:
      - 8082:8082
    environment:
      - ACCESS_CONTROL_ALLOW_ORIGIN_DEFAULT="*"
      - KAFKA_REST_ZOOKEEPER_CONNECT=zookeeper:2181
      - KAFKA_REST_LISTENERS=http://kafka-rest:8082
      - KAFKA_REST_HOST_NAME=kafka-rest
      - KAFKA_REST_CONSUMER_REQUEST_TIMEOUT_MS=30000
      - KAFKA_REST_BOOTSTRAP_SERVERS=PLAINTEXT://kafka:9092
      - KAFKA_REST_LOG4J_ROOT_LOGLEVEL=WARN
    links:
      - zookeeper
      - kafka

  kafka-topic-ui:
    image: landoop/kafka-topics-ui:0.9.4
    ports:
      - 9991:8000
    environment:
      - KAFKA_REST_PROXY_URL=http://kafka-rest:8082
      - SCHEMAREGISTRY_UI_URL=http://schema-registry:8081
      - PROXY=true
    links:
      - kafka
      - zookeeper
      - kafka-rest

  connect:
    image: debezium/connect:1.1.1.Final
    ports:
      - 8083:8083
    links:
      - kafka
      - event-store
    environment:
      - BOOTSTRAP_SERVERS=kafka:9092
      - GROUP_ID=1
      - CONFIG_STORAGE_TOPIC=my_connect_configs
      - OFFSET_STORAGE_TOPIC=my_connect_offsets
      - STATUS_STORAGE_TOPIC=my_connect_statuses
      - LOG_LEVEL=WARN

  event-store:
    image: dcdh1983/postgresql-10-debezium-centos7:latest
    ports:
      - 5432:5432
    environment:
      - POSTGRESQL_USER=postgresuser
      - POSTGRESQL_PASSWORD=postgres
      - POSTGRESQL_DATABASE=event-store

  todo-email-notifier-query:
    image: postgres:11-alpine
    ports:
      - 5434:5432
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_DB=todoemailnotifier

  mailhog:
    image: mailhog/mailhog:v1.0.0
    ports:
      - 1025:1025
      - 8025:8025

  secret-store:
    image: debezium/postgres:11-alpine
    ports:
      - 5435:5432
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_DB=secret-store

  todo-write-app:
    image: damdamdeo/todo-write-app:latest
    ports:
      - 8084:8084
    environment:
      - JAVA_OPTIONS=-Dquarkus.http.host=0.0.0.0 -Dquarkus.datasource.jdbc.url=jdbc:postgresql://event-store:5432/event-store -Dquarkus.datasource.secret-store.jdbc.url=jdbc:postgresql://secret-store:5432/secret-store -Dmp.messaging.incoming.event-in.bootstrap.servers=kafka:9092
    links:
      - zookeeper
      - kafka
      - connect
      - event-store
      - secret-store